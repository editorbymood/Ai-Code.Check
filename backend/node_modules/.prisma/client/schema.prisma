generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// User & Auth
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String
  role          String   @default("USER")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenantId      String?
  tenant        Tenant?  @relation(fields: [tenantId], references: [id])
  
  reviews       Review[]
  name            String?
  marketingEmails Boolean @default(true)
  securityAlerts  Boolean @default(true)
  
  apiKeys         ApiKey[]
  integrations    Integration[]
}

model ApiKey {
  id        String   @id @default(uuid())
  key       String   @unique
  name      String
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  lastUsed  DateTime?
}

model Integration {
  id          String   @id @default(uuid())
  provider    String   // github, gitlab, etc.
  accessToken String?
  refreshToken String?
  profileData String?  // JSON
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())
}

// Multi-tenancy
model Tenant {
  id          String   @id @default(uuid())
  name        String
  plan        String   @default("FREE")
  createdAt   DateTime @default(now())
  
  users       User[]
  repos       Repository[]
}

// Code Repositories
model Repository {
  id          String   @id @default(uuid())
  name        String
  url         String?
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  createdAt   DateTime @default(now())

  reviews     Review[]
}

// Reviews & Jobs
model Review {
  id          String       @id @default(uuid())
  repoId      String?
  repo        Repository?  @relation(fields: [repoId], references: [id])
  userId      String?
  user        User?        @relation(fields: [userId], references: [id])
  
  status      String   @default("QUEUED") // QUEUED, PROCESSING, COMPLETED, FAILED
  score       Int?
  summary     String?
  
  createdAt   DateTime     @default(now())
  finishedAt  DateTime?

  // A review can have one snapshot (single file/text) OR a set of files
  codeSnapshot String?       // Legacy / Snippet
  files        ReviewFile[]  // For Zip uploads

  agentOutputs AgentOutput[] // Overall outputs or summaries
}

model ReviewFile {
  id        String   @id @default(uuid())
  reviewId  String
  review    Review   @relation(fields: [reviewId], references: [id])
  
  path      String   // File path in repo
  content   String   // File content
  language  String   @default("text")

  agentOutputs AgentOutput[] // Per-file outputs
}

// Individual Agent Results
model AgentOutput {
  id          String   @id @default(uuid())
  
  // Can belong to a Review (Overall) OR a Specific File
  reviewId    String?
  review      Review?   @relation(fields: [reviewId], references: [id])

  fileId      String?
  file        ReviewFile? @relation(fields: [fileId], references: [id])
  
  agentType   String   
  content     String   // JSON Result
  createdAt   DateTime @default(now())
}
